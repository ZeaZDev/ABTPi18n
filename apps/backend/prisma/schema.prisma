// ZeaZDev [Database Schema Prisma] //
// Project: Auto Bot Trader i18n //
// Version: 1.0.0 (Omega Scaffolding) //
// Author: ZeaZDev Meta-Intelligence (Generated) //
// --- DO NOT EDIT HEADER --- //

generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                     @id @default(autoincrement())
  email                  String                  @unique
  // OAuth fields for Phase 3
  googleId               String?                 @unique
  oauthProvider          String?
  profilePicture         String?
  createdAt              DateTime                @default(now())
  exchangeKeys           ExchangeKey[]
  botRuns                BotRun[]
  tradeLogs              TradeLog[]
  rentalContracts        RentalContract[]
  telegramLink           TelegramLink?
  promptpayTopups        PromptPayTopup[]
  modules                ModuleRegistration[]
  notificationPreference NotificationPreference?
  userPreference         UserPreference?
  // Phase 4 relations
  wallet                 Wallet?
  transactions           Transaction[]
  userPlugins            UserPlugin[]
  accounts               Account[]
  backtestRuns           BacktestRun[]
  paperTradingSessions   PaperTradingSession[]
  // Phase 5 relations
  auditLogs              AuditLog[]
  secretRotations        SecretRotation[]
  // Phase 6 relations
  mlSignalScores         MLSignalScore[]
  strategyOptimizations  StrategyOptimization[]
}

model ExchangeKey {
  id               Int       @id @default(autoincrement())
  exchange         String
  encrypted_key    String
  iv_key           String
  encrypted_secret String
  iv_secret        String
  createdAt        DateTime  @default(now())
  ownerId          Int?
  owner            User?     @relation(fields: [ownerId], references: [id])
  // Phase 4: Support for multi-account
  accounts         Account[]
}

model Strategy {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model BotRun {
  id        Int        @id @default(autoincrement())
  userId    Int
  user      User       @relation(fields: [userId], references: [id])
  strategy  String
  symbol    String
  timeframe String
  status    String     @default("RUNNING")
  startedAt DateTime   @default(now())
  stoppedAt DateTime?
  tradeLogs TradeLog[]
}

model TradeLog {
  id        Int      @id @default(autoincrement())
  botRunId  Int
  botRun    BotRun   @relation(fields: [botRunId], references: [id])
  side      String
  quantity  Float
  price     Float
  pnl       Float    @default(0)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
  userId    Int?
}

model RentalContract {
  id              Int       @id @default(autoincrement())
  userId          Int
  user            User      @relation(fields: [userId], references: [id])
  plan            String // BASIC, PREMIUM, ENTERPRISE
  expiry          DateTime
  status          String    @default("ACTIVE") // ACTIVE, EXPIRED, SUSPENDED
  gracePeriodDays Int       @default(3)
  autoRenew       Boolean   @default(false)
  features        String? // JSON array of enabled features
  createdAt       DateTime  @default(now())
  renewedAt       DateTime?
}

model PromptPayTopup {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id])
  amount      Float
  currency    String    @default("THB")
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now())
  confirmedAt DateTime?
}

model ModuleRegistration {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  moduleName String
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
}

model TelegramLink {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id])
  chatId    String
  username  String?
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NotificationPreference {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  user         User     @relation(fields: [userId], references: [id])
  tradeAlerts  Boolean  @default(true)
  riskAlerts   Boolean  @default(true)
  systemAlerts Boolean  @default(true)
  dailySummary Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model UserPreference {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  user            User     @relation(fields: [userId], references: [id])
  theme           String   @default("auto")
  language        String   @default("th")
  primaryColor    String?
  secondaryColor  String?
  accentColor     String?
  dashboardLayout String   @default("grid")
  refreshInterval Int      @default(30)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ===== Phase 4 Models =====

model Wallet {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id])
  balance   Float    @default(0)
  currency  String   @default("THB")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id            Int       @id @default(autoincrement())
  userId        Int
  user          User      @relation(fields: [userId], references: [id])
  type          String // TOP_UP, DEDUCTION, REFUND
  amount        Float
  currency      String    @default("THB")
  status        String    @default("PENDING")
  paymentMethod String? // PROMPTPAY, CREDIT_CARD
  referenceId   String?   @unique
  metadata      String? // JSON for additional data
  createdAt     DateTime  @default(now())
  completedAt   DateTime?
}

model Plugin {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  version     String
  type        String // STRATEGY, INDICATOR, NOTIFICATION, DATASOURCE
  entryPoint  String
  author      String?
  description String?
  verified    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  userPlugins UserPlugin[]
}

model UserPlugin {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  pluginId  Int
  plugin    Plugin   @relation(fields: [pluginId], references: [id])
  enabled   Boolean  @default(false)
  config    String? // JSON configuration
  createdAt DateTime @default(now())

  @@unique([userId, pluginId])
}

model Account {
  id            Int         @id @default(autoincrement())
  userId        Int
  user          User        @relation(fields: [userId], references: [id])
  exchangeKeyId Int
  exchangeKey   ExchangeKey @relation(fields: [exchangeKeyId], references: [id])
  label         String // User-defined label for account
  group         String? // Optional grouping
  enabled       Boolean     @default(true)
  createdAt     DateTime    @default(now())
  positions     Position[]
}

model Position {
  id           Int      @id @default(autoincrement())
  accountId    Int
  account      Account  @relation(fields: [accountId], references: [id])
  symbol       String
  side         String // LONG, SHORT
  quantity     Float
  entryPrice   Float
  currentPrice Float?
  pnl          Float    @default(0)
  updatedAt    DateTime @updatedAt

  @@unique([accountId, symbol])
}

model BacktestRun {
  id             Int       @id @default(autoincrement())
  userId         Int
  user           User      @relation(fields: [userId], references: [id])
  strategyName   String
  symbol         String
  timeframe      String
  startDate      DateTime
  endDate        DateTime
  initialCapital Float
  status         String    @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  results        String? // JSON with metrics
  createdAt      DateTime  @default(now())
  completedAt    DateTime?
}

model PaperTradingSession {
  id             Int       @id @default(autoincrement())
  userId         Int
  user           User      @relation(fields: [userId], references: [id])
  strategyName   String
  symbol         String
  timeframe      String
  virtualBalance Float     @default(10000)
  currentBalance Float?
  status         String    @default("ACTIVE")
  startedAt      DateTime  @default(now())
  stoppedAt      DateTime?
}

// ===== Phase 5 Models =====

model AuditLog {
  id          Int      @id @default(autoincrement())
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id])
  action      String   // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT
  resource    String   // API endpoint or resource type
  method      String   // GET, POST, PUT, DELETE
  statusCode  Int
  ipAddress   String?
  userAgent   String?
  requestData String?  // JSON (sanitized)
  metadata    String?  // JSON for additional context
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

model SecretRotation {
  id           Int       @id @default(autoincrement())
  secretType   String    // DATABASE, ENCRYPTION_KEY, API_KEY, OAUTH_SECRET
  secretName   String    // Identifier for the secret
  rotatedAt    DateTime  @default(now())
  rotatedBy    Int?
  user         User?     @relation(fields: [rotatedBy], references: [id])
  previousHash String?   // Hash of previous value for verification
  nextRotation DateTime  // Scheduled next rotation date
  status       String    @default("ACTIVE") // ACTIVE, DEPRECATED, ROTATED
  metadata     String?   // JSON for additional info

  @@index([secretType])
  @@index([secretName])
  @@index([nextRotation])
  @@index([status])
}

// Phase 6: ML / Intelligence Models

model MLSignalScore {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  symbol      String
  timeframe   String
  strategy    String
  score       Float
  confidence  Float
  features    String   // JSON
  prediction  String?  // BUY, SELL, HOLD
  executed    Boolean  @default(false)
  outcome     String?  // WIN, LOSS, PENDING
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([symbol, strategy])
  @@index([createdAt])
}

model MLModelTraining {
  id              Int       @id @default(autoincrement())
  modelType       String    // SIGNAL_QUALITY, RL_TUNER, VOLATILITY
  modelVersion    String
  trainingData    String    // JSON
  hyperparameters String    // JSON
  performance     String    // JSON (metrics like accuracy, MAE, etc.)
  status          String    // TRAINING, COMPLETED, FAILED
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  errorMessage    String?

  @@index([modelType, status])
  @@index([status])
}

model StrategyOptimization {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  strategy        String
  originalParams  String   // JSON
  optimizedParams String   // JSON
  performance     String   // JSON (before/after metrics)
  method          String   // RL, GRID_SEARCH, BAYESIAN
  iterations      Int      @default(0)
  status          String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([userId, strategy])
  @@index([status])
  @@index([createdAt])
}

model VolatilityPrediction {
  id          Int      @id @default(autoincrement())
  symbol      String
  timeframe   String
  predicted   Float
  actual      Float?
  confidence  Float
  features    String   // JSON
  horizon     Int      // Prediction horizon in hours
  createdAt   DateTime @default(now())

  @@index([symbol, createdAt])
  @@index([createdAt])
}

// TradingView Integration Model

model TradingViewAlert {
  id         Int       @id @default(autoincrement())
  ticker     String
  exchange   String    @default("binance")
  action     String    // BUY, SELL, CLOSE, HOLD
  price      Float?
  strategy   String?
  interval   String?
  volume     Float?
  message    String?
  rawPayload String?   // JSON of complete payload
  receivedAt DateTime  @default(now())
  processed  Boolean   @default(false)
  
  @@index([ticker, receivedAt])
  @@index([action])
  @@index([receivedAt])
}
